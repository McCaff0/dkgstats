<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1", maximum-scale=1>
  <link href="https://fonts.googleapis.com/css2?family=Play&display=swap" rel="stylesheet">
  <title>DKGStats.io</title>
  <meta name="description" content="Real-time statistics on the OriginTrail Decentralised Knowledge Graph.">
  <meta name="keywords" content="OriginTrail, Decentralised Knowledge Graph, DKG, TRAC, DKG analytics, DKG Stats, staking APY, TRAC price, knowledge assets, base, gnosis, neuroweb, crypto, OT, blockchain">
  <meta name="author" content="McCaff">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="DKGStats.io">
  <meta property="og:description" content="Real-time statistics on the OriginTrail Decentralised Knowledge Graph.">
  <meta property="og:image" content="https://dkgstats.io/preview-image.jpg">
  <meta property="og:url" content="https://dkgstats.io">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="DKGStats.io">
  <meta name="twitter:description" content="Real-time statistics on the OriginTrail Decentralised Knowledge Graph.">
  <meta name="twitter:image" content="https://dkgstats.io/preview-image.jpg">

  <link rel="icon" type="image/png" href="/assets/favicons/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/assets/favicons/favicon.svg" />
  <link rel="shortcut icon" href="/assets/favicons/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="DKGStats.IO" />
  <link rel="manifest" href="/assets/favicons/site.webmanifest" />
  <link rel="canonical" href="https://dkgstats.io">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
 
  <link rel="canonical" href="https://dkgstats.io">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
        padding: 0;
        width: 100%;
        height: 100%;
  }
      body {
        font-family: 'Play', sans-serif;
        background: #0a0a0a;
        color: #dadada;
        padding: 1.25rem;
        text-align: center;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 16px
}
    
h1 {
  display: none;
}

    .title-image {
      width: 29rem;
      max-width: 80%;
      display: block;
      margin: -1.25rem auto -0.25rem auto;
}

    .main-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      width: 97vw;
      margin: 0 auto;
}
    .sub-container {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
      min-width: 24.75rem;
      max-width: 55.625rem;
      min-height: auto;
      flex-grow: 1;
}

      .container {
        background: #373737;
        padding: 0.5rem;
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        gap: 0.5rem;
        max-width: 27.5625rem;
        min-width: 24.75rem;
        flex-grow: 1;
        position: relative;
        height: 50rem;

}
    
      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        box-shadow: 0 0 6.25rem rgb(78 78 78 / 40%);
        border-radius: 1rem;
        z-index: -1;
}
    
      .stats-box {
        background: #0f0f0f;
        padding: 0.5rem;
        border-radius: 0.5rem;
        min-width: 23.75rem;
        max-width: 26.5625rem;
        width: 100%;
}
      
      .stats-box h3 {
        text-align: center;
        font-size: 1.25rem;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 0;
        color: #acafb0;
}
      
      .stats-box p {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        margin: 0.2rem 0;
        color: #b4b7b8;
}
      .stats-box:nth-of-type(1) {
        height: 36.25rem;
}

      .stats-box:nth-of-type(2) {
        height:12.25rem;
}

      .half-line {
        display: block;
        height: 0.875rem
}
             .pie-space {
        display: block;
        height: 6.5rem
}
       
      .value-container {
        position: relative;
        width: 10rem;
        height: 2.5rem;
}
      
      .number-value {
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        text-align: right;
        width: 100%;
}
      
      .percentage-change {
        position: absolute;
        right: 0;
        top: 96%;
        transform: translateY(-50%);
        text-align: right;
        font-size: 1rem;
        width: 100%;
}
      
      .positive { color: #1c941c; }
      .negative { color: #c91e1e; }
      .neutral  { color: #a6a6a6; }

      .container.new {
        position: relative;
        
}
      .container.new::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        box-shadow: 0 0 6.25rem rgb(78 78 78 / 40%);
        z-index: -1;
}

    .graph-box {
        background: #0f0f0f;
        border-radius: 0.5rem;
        min-width: 23.75rem;
        max-width: 26.5625rem;
        width: 100%;
        height: 16rem; 
        position: relative; 
        align-items: center;
        justify-content: center;
}

    .graph-box canvas {
        position: absolute; 
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        max-width: 100%;
        max-height: 100%;
        pointer-events: none; 
}

.graph-box h3 {
  font-family: 'Play', sans-serif;
  font-size: 1.125rem;
  font-weight: bold;
  text-align: center;
  margin-top: 0.25rem;
  margin-bottom: -0.3125rem;
  color: #999999;
}
.stats-box.new {
  height: 11rem;
}

.epoch-box {
    background: #0f0f0f;
    border-radius: 0.5rem;
    min-width: 23.75rem;
    max-width: 26.5625rem;
    width: 100%;
    height: 16rem;
    position: relative;
    align-items: center;
    justify-content: center;
    padding: 0rem;
}

.epoch-box canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 8.5rem !important;
    max-width: 100%;
    max-height: 8.5rem;
    pointer-events: none;
}
#customLegendContainer,
#customRewardsLegendContainer,
#customStakedLegendContainer {
    position: absolute;
    right: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0;
    font-family: "Play", sans-serif;
    font-size: 1rem;
    color: #a6a6a6;
    z-index: 10;
    width: 59.3%;
}

#customLegendContainer {
    top: 4.35rem;
}

#customRewardsLegendContainer {
    top: 12.6rem;
}

#customStakedLegendContainer {
    top: 20.8rem;
}
  
  #publishesPieChart {
  margin-top: 1.5rem;
    left: -33%;
  }
  
  #rewardsPieChart {
      margin-top: 9.75rem;
      left: -33%;
  }
  
  #stakedPieChart {
      margin-top: 17.95rem;
      left: -33%;
  }
      .epoch-box h2 {
        text-align: center;
        font-size: 1.25rem;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 0;
        color: #acafb0;
        margin-top: 0.5rem
}
.epoch-box h3 {
    font-family: 'Play', sans-serif;
    font-size: 1.125rem;
    font-weight: bold;
    text-align: left;
    margin-top: 0.7rem;
    margin-bottom: -0.3125rem;
    margin-left: 35%;
    color: #999999;
}

.epoch-box:nth-of-type(2) {
    height: 26.7rem;
}

.epoch-box:nth-of-type(3) {
    height: 10.3rem;
}
    .date-value {
   position: absolute;
        right: 0;
        top: 96%;
        transform: translateY(-50%);
        text-align: right;
        font-size: 1rem;
        width: 100%;
      color: #656666;
}

</style>
  <!-- Google Analytics Tag -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-16V8B7YWR9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-16V8B7YWR9');
  </script>
  
</head>
<body>
  <div class="scale-wrapper">
<img src="https://raw.githubusercontent.com/McCaff0/dkgstats/main/title-image.png" alt="DKGStats.io" class="title-image">
<h1>DKGStats.io - Real-Time OriginTrail DKG Statistics</h1>
<div class="main-container">
  <!-- First Sub-container -->
  <div class="sub-container">
    <!-- First container with stats-boxes -->
    <div class="container">
      <div class="stats-box">
        <h3>Current</h3>
        <p>
          <span>TRAC Price</span>
          <span class="value-container">
            <span id="tracprice" class="number-value">Loading...</span>
            <span id="pricechange1d" class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Market Cap</span>
          <span class="value-container">
            <span id="marketcap" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>P/E Ratio</span>
          <span class="value-container">
            <span id="peratio" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <span class="half-line"></span>
        <p>
          <span>TRAC Staked</span>
          <span class="value-container">
            <span id="tracstaked" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Staking APY</span>
          <span class="value-container">
            <span id="stakingapy" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <h3>30 Day Averages</h3>
        <p>
          <span>Annual Spend (USD)</span>
          <span class="value-container">
            <span id="annualspend" class="number-value">Loading...</span>
            <span id="annualspendchange30d" class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Daily Spend (TRAC)</span>
          <span class="value-container">
            <span id="dailyspend" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Daily Publishes</span>
          <span class="value-container">
            <span id="dailypublishes" class="number-value">Loading...</span>
            <span id="dailypublisheschange30d" class="percentage-change"></span>
          </span>
        </p>
        <span class="half-line"></span>
        <p>
          <span>Publish Price (TRAC)</span>
          <span class="value-container">
            <span id="publishpricetrac" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Publish Price (USD)</span>
          <span class="value-container">
            <span id="publishpriceusd" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Operator Fee</span>
          <span class="value-container">
            <span id="stakingfee" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
      </div>

      <div class="stats-box">
        <p>
          <span>Total KA'S</span>
          <span class="value-container">
            <span id="totalkas" class="number-value">Loading...</span>
            <span id="kas24h" class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Total TRAC Spent</span>
          <span class="value-container">
            <span id="totaltracspent" class="number-value">Loading...</span>
            <span id="spend24h" class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Active Nodes</span>
          <span class="value-container">
            <span id="activenodes" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
        <p>
          <span>Paranets</span>
          <span class="value-container">
            <span id="paranets" class="number-value">Loading...</span>
            <span class="percentage-change"></span>
          </span>
        </p>
      </div>
    </div>

    <!-- Second container with graph-boxes -->
    <div class="container new">
      <div class="graph-box">
        <h3>TRAC Price (90D)</h3>
        <canvas id="PriceChart"></canvas>
      </div>
      <div class="graph-box">
        <h3>Daily USD Spend (90D)</h3>
        <canvas id="SpendChart"></canvas>
      </div>
      <div class="graph-box">
        <h3>Daily Publishes (90D)</h3>
        <canvas id="PublishesChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Second Sub-container -->
  <div class="sub-container">
<!-- Second container with graph-boxes -->
<div class="container new">
  <!-- First stats-box for Records -->
  <div class="stats-box new">
    <h3>RECORDS</h3>

    <p>
      <span>Daily Publishes</span>
      <span class="value-container">
        <span id="publishRecordValue" class="number-value">Loading...</span>
        <span id="publishRecordDate" class="date-value"></span>
      </span>
    </p>

    <p>
      <span>Daily Spend (TRAC)</span>
      <span class="value-container">
        <span id="tracSpendRecordValue" class="number-value">Loading...</span>
        <span id="tracSpendRecordDate" class="date-value"></span>
      </span>
    </p>

    <p>
      <span>Daily Spend (USD)</span>
      <span class="value-container">
        <span id="usdSpendRecordValue" class="number-value">Loading...</span>
        <span id="usdSpendRecordDate" class="date-value"></span>
      </span>
    </p>
  </div>

  <!-- Second epoch-box for 3 pie charts -->
  <div class="epoch-box">
    <h2>CURRENT EPOCH</h2>
    <h3>Total Publishes</h3>
    <canvas id="publishesPieChart"></canvas>
    <div id="customLegendContainer"></div>
    <span class="pie-space"></span>

    <h3>Estimated Rewards</h3>
    <canvas id="rewardsPieChart"></canvas>
    <div id="customRewardsLegendContainer"></div>
    <span class="pie-space"></span>

    <h3>Staked on Active Nodes</h3>
    <canvas id="stakedPieChart"></canvas>
    <div id="customStakedLegendContainer"></div>
    <span class="pie-space"></span>
  </div>

  <div class="epoch-box">
  <h2>EPOCH AVERAGES</h2>
</div>
</div>
    <div class="container new">
      <div class="graph-box"></div>
      <div class="graph-box"></div>
      <div class="graph-box"></div>
    </div>
  </div>
</div>

  
  <script>
    function formatNumber(value, decimals = 0, isCurrency = false) {
      if (value == null || value === '') return 'Loading...';
      let number = Number(value);
      if (isNaN(number)) return value;
      let [integer, decimal] = number.toFixed(decimals).split('.');
      let formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return decimal ? formattedInteger + '.' + decimal : formattedInteger;
    }
    
    function formatPercentage(value, period) {
      if (value == null || value === '') return ' ';
      let number = Number(value);
      if (isNaN(number)) return value;
      let sign = number > 0 ? '+' : number < 0 ? '-' : '';
      let className = number > 0 ? 'positive' : number < 0 ? 'negative' : 'neutral';
      let p = Math.abs(number) * 100;
      let formatted;
      if (p < 10) {
        formatted = p.toFixed(2);
      } else if (p < 100) {
        formatted = p.toFixed(1);
      } else {
        formatted = p.toFixed(0);
      }
      return '<span class="' + className + '">' + sign + formatted + '% (' + period + ')</span>';
    }

    function formatNumberChange(value, label = '') {
      if (value == null || value === '') return ' ';
      let number = Number(value);
      if (isNaN(number)) return value;
      
      let sign = number > 0 ? '+' : number < 0 ? '-' : '';
      let className = number > 0 ? 'positive' : number < 0 ? 'negative' : 'neutral';
    
      let [integer, decimal] = Math.abs(number).toFixed(0).split('.');
      let formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
      let formattedNumber = decimal ? formattedInteger + '.' + decimal : formattedInteger;
    
      return '<span class="' + className + '">' + sign + formattedNumber + '</span>' + 
             (label ? ' <span class="' + className + '">' + label + '</span>' : '');
      
    }

    function formatDate(isoDate) {
      console.log("formatDate input:", isoDate);
      if (!isoDate) return 'N/A';
      const date = new Date(isoDate);
      if (isNaN(date.getTime())) return 'N/A';
      let result = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit'
      });
      console.log("formatDate output:", result);
      return result;
    }

        function formatValueInMillions(value) {
    if (typeof value !== "number" || isNaN(value)) {
        return "0"; // Return a default value if the input is invalid
    }

    if (value >= 1000000) {
        // Format as 1.0M, 2.5M, etc.
        return `${(value / 1000000).toFixed(1)}M`;
    } else if (value >= 1000) {
        // Format as 1.2K, 45.6K, etc.
        return `${(value / 1000).toFixed(1)}K`;
    } else {
        // Format as whole numbers for values less than 1000
        return Math.round(value).toString();
    }
}
    
function handleData(sheetData, records) {
    console.log("✅ handleData received:");
    console.log("➡ sheetData:", sheetData);
    console.log("➡ records:", records);

    if (!sheetData || !records) {
        console.error("❌ Missing required data:", { sheetData, records });
        return;
    }

    const updateText = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.innerText = value;
        else console.warn(`⚠️ Element #${id} not found in DOM.`);
    };

    const updateHTML = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = value;
        else console.warn(`⚠️ Element #${id} not found in DOM.`);
    };

    updateText('tracprice', formatNumber(sheetData.tracprice, 4));
    updateText('marketcap', formatNumber(sheetData.marketcap, 0, true));
    updateText('peratio', formatNumber(sheetData.peratio, 1));
    updateText('tracstaked', formatNumber(sheetData.tracstaked, 0, true));
    updateText('stakingapy', formatNumber(sheetData.stakingapy * 100, 2) + '%');
    updateText('annualspend', formatNumber(sheetData.annualspend, 0, true));
    updateText('dailyspend', formatNumber(sheetData.dailyspend, 0, true));
    updateText('dailypublishes', formatNumber(sheetData.dailypublishes, 0));
    updateText('publishpricetrac', formatNumber(sheetData.publishpricetrac, 6));
    updateText('publishpriceusd', formatNumber(sheetData.publishpriceusd, 6));
    updateText('stakingfee', formatNumber(sheetData.stakingfee * 100, 2) + '%');
    updateText('totalkas', formatNumber(sheetData.totalkas, 0));
    updateText('totaltracspent', formatNumber(sheetData.totaltracspent, 0));
    updateText('activenodes', formatNumber(sheetData.activenodes, 0));
    updateText('paranets', formatNumber(sheetData.paranets, 0));

    updateHTML('pricechange1d', formatPercentage(sheetData.pricechange1d, '24H'));
    updateHTML('dailypublisheschange30d', formatPercentage(sheetData.dailypublisheschange30d, '30D'));
    updateHTML('annualspendchange30d', formatPercentage(sheetData.annualspendchange30d, '30D'));
    updateHTML('kas24h', formatNumberChange(sheetData.kas24h, '(24H)'));
    updateHTML('spend24h', formatNumberChange(sheetData.spend24h, '(24H)'));

    const updateRecordData = (record, dateId, valueId, decimals = 0, currency = false) => {
        if (!record) {
            console.warn(`⚠️ Missing record data for ${dateId} and ${valueId}`);
            return;
        }
        updateText(dateId, formatDate(record.date));
        updateText(valueId, formatNumber(record.value, decimals, currency));
    };

    console.log("📌 Checking Records Data:");
    console.log("➡ Publish Record:", records.publishRecord);
    console.log("➡ TRAC Spend Record:", records.tracSpendRecord);
    console.log("➡ USD Spend Record:", records.usdSpendRecord);

    updateRecordData(records.publishRecord, 'publishRecordDate', 'publishRecordValue');
    updateRecordData(records.tracSpendRecord, 'tracSpendRecordDate', 'tracSpendRecordValue');
    updateRecordData(records.usdSpendRecord, 'usdSpendRecordDate', 'usdSpendRecordValue');
}

function fetchData() {
  const FIREBASE_URL = 'https://dkgstats-b5839-default-rtdb.firebaseio.com/data.json';

  // Return the fetch chain to make it chainable
  return fetch(FIREBASE_URL)
    .then(response => response.json())
    .then(data => {
      console.log("Fetched Data:", data);

      const sheetData = data.sheetData;
      const records = data.records;

      console.log("Sheet Data:", sheetData);
      console.log("Records Data:", records);

      if (sheetData) {
        console.log("Handling Data with sheetData...");
        handleData(sheetData, records);
      } else {
        console.error("Error: sheetData not found");
      }

      return data; // Return the data for further processing
    })
    .catch(error => {
      console.error('Error fetching data:', error);
      throw error; // Re-throw the error to be caught by the caller
    });
}
    
function updateFontSizesAndPadding() {
    const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);
    tickFontSize = rootFontSize * 0.75;
    labelFontSize = rootFontSize * 0.875;

    chartPadding = {
        left: rootFontSize * 0.625,
        right: rootFontSize * 1.5625,
        top: rootFontSize * 1.8,
        bottom: rootFontSize * 0
    };
}

let pieChartFontSize, pieChartLayoutPadding, pieChartLegendPadding, pieChartBorderWidth;

function updatePieChartFontSizesAndPadding() {
    const rootFontSize = parseFloat(getComputedStyle(document.documentElement).fontSize);

    // Font size for legend labels
    pieChartFontSize = rootFontSize * 1.05;

    // Individual padding values for layout
    pieChartLayoutPadding = {
        left: rootFontSize * 0,   // Adjust left padding
        top: rootFontSize * 1.1,  // Adjust top padding
        right: rootFontSize * 0,  // Adjust right padding
        bottom: rootFontSize * 1 // Adjust bottom padding
    };

    // Padding between legend items
    pieChartLegendPadding = rootFontSize * 0.7;

    // Border width of the pie chart segments
    pieChartBorderWidth = Math.max(1, rootFontSize * 0.125);
}
function reapplyScaling() {
    console.log('Reapplying scaling...');
    adjustFontSize();
    resizeCharts();
}
    
let stableHeight = null;

function hasTrueWindowResizing() {
    if (!('ontouchstart' in window)) return true;
    return window.matchMedia("(min-width: 1024px)").matches;
}

function adjustFontSize() {
    let referenceHeight;

    if (hasTrueWindowResizing()) {
        referenceHeight = Math.min(window.innerHeight, window.screen.height);
        stableHeight = null;
    } else {
        if (stableHeight === null) {
            stableHeight = Math.min(window.innerHeight, window.screen.height);
        }
        referenceHeight = stableHeight;
    }

    const baseFontSize = 16;
    const scalingFactor = referenceHeight / 973;
    let newFontSize = baseFontSize * scalingFactor * 1.07;

    const minScaleFactor = 0.6; 
    const minFontSize = baseFontSize * (window.screen.height * minScaleFactor / 973) * 1.07;
    newFontSize = Math.max(newFontSize, minFontSize);

    const container = document.querySelector('.container');
    if (!container) return; 

    requestAnimationFrame(() => {
        const containerWidth = container.offsetWidth;
        const viewportWidth = window.innerWidth;
        const maxWidth = 0.98 * viewportWidth;

        if (containerWidth > maxWidth) {
            const widthRatio = maxWidth / containerWidth;
            newFontSize *= widthRatio;
        }

        document.documentElement.style.setProperty('font-size', `${newFontSize}px`);
        updateFontSizesAndPadding();
        resizeCharts();
    });
}

function resizeCharts() {
    updateFontSizesAndPadding();
    updatePieChartFontSizesAndPadding();

    const chartInstances = [PublishesChartInstance, PriceChartInstance, SpendChartInstance];
    
    chartInstances.forEach(chart => {
        if (chart) {
            chart.options.scales.x.ticks.font.size = tickFontSize;
            chart.options.scales.y.ticks.font.size = tickFontSize;
            chart.options.scales.y.title.font.size = labelFontSize;
            chart.options.layout.padding = chartPadding;
            chart.update();
        }
    });

    const pieChartInstances = [window.publishesPieChartInstance, window.rewardsPieChartInstance, window.stakedPieChartInstance];

    pieChartInstances.forEach(chart => {
        if (chart) {
            chart.options.layout.padding = pieChartLayoutPadding;
            chart.options.elements.arc.borderWidth = pieChartBorderWidth;
            chart.update();
        }
    });
}

let resizeTimeout;

function handleResize() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        adjustFontSize();
        resizeCharts();
    }, 200);
}

window.addEventListener('orientationchange', () => {
    stableHeight = null;
    clearTimeout(resizeTimeout);
    setTimeout(() => {
        handleResize();
    }, 200);
});

window.addEventListener('resize', handleResize);

document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM fully loaded and parsed');

    // Check if fetchData is defined
    if (typeof fetchData !== 'function') {
        console.error('fetchData is not a function');
        return;
    }

    // Reset first load flags for pie charts
    isFirstLoadPublishes = true;
    isFirstLoadRewards = true;
    isFirstLoadStaked = true;

    // Initial font size adjustment and chart resize
    adjustFontSize();
    resizeCharts();

    // Render line charts with empty data initially
    PriceChartInstance = renderChart({
        canvasId: 'PriceChart',
        labels: [],
        values: [],
        datasetLabel: 'Price',
        yAxisTitle: 'Price (USD)',
        animate: false,
        chartInstance: PriceChartInstance,
        isFirstLoad: isFirstDataLoad
    });

    SpendChartInstance = renderChart({
        canvasId: 'SpendChart',
        labels: [],
        values: [],
        datasetLabel: 'Spend',
        yAxisTitle: 'Spend (USD)',
        yAxisFormatter: (value) => value >= 1000 ? (value / 1000) + 'K' : value,
        animate: false,
        chartInstance: SpendChartInstance,
        isFirstLoad: isFirstSpendLoad
    });

    PublishesChartInstance = renderChart({
        canvasId: 'PublishesChart',
        labels: [],
        values: [],
        datasetLabel: 'Publishes',
        yAxisTitle: 'Publishes',
        yAxisFormatter: (value) => value >= 1000000 ? (value / 1000000) + 'M' : value,
        animate: false,
        chartInstance: PublishesChartInstance,
        isFirstLoad: isFirstPublishesLoad
    });

    // Render pie charts with empty data initially
    renderPieChart({
        canvasId: 'publishesPieChart',
        legendContainerId: 'customLegendContainer',
        data: [], // Empty array for initial render
        chartInstance: window.publishesPieChartInstance,
        isFirstLoad: isFirstLoadPublishes
    });

    renderPieChart({
        canvasId: 'rewardsPieChart',
        legendContainerId: 'customRewardsLegendContainer',
        data: [], // Empty array for initial render
        chartInstance: window.rewardsPieChartInstance,
        isFirstLoad: isFirstLoadRewards
    });

    renderPieChart({
        canvasId: 'stakedPieChart',
        legendContainerId: 'customStakedLegendContainer',
        data: [], // Empty array for initial render
        chartInstance: window.stakedPieChartInstance,
        isFirstLoad: isFirstLoadStaked
    });

    // Fetch actual data
    console.log('Calling fetchData...');
    fetchData()
        .then(() => {
            console.log('fetchData completed successfully');
            fetchChartData();
            fetchPieChartData();
        })
        .catch((error) => {
            console.error('Error in fetchData:', error);
        });
});
    window.addEventListener('load', function () {
    console.log('Page fully loaded');

    reapplyScaling();

    setTimeout(reapplyScaling, 1000);
});

let PriceChartInstance, SpendChartInstance, PublishesChartInstance;
let priceLabels = [], priceValues = [];
let spendLabels = [], spendValues = [];
let publishesLabels = [], publishesValues = [];

let isFirstLoadPublishes = true, isFirstLoadRewards = true, isFirstLoadStaked = true;

let tickFontSize, labelFontSize, chartPadding;

let isFirstDataLoad = true, isFirstSpendLoad = true, isFirstPublishesLoad = true;

function resetCanvas(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`${canvasId} canvas not found!`);
        return;
    }

    // Remove the canvas element from the DOM
    const parent = canvas.parentElement;
    const newCanvas = document.createElement('canvas');
    newCanvas.id = canvasId;
    parent.removeChild(canvas);
    parent.appendChild(newCanvas);

    // Clear the chart instance reference
    if (window[`${canvasId}Instance`]) {
        window[`${canvasId}Instance`].destroy();
        window[`${canvasId}Instance`] = null;
    }
}
    
function renderChart({
    canvasId,
    labels,
    values,
    datasetLabel,
    yAxisTitle,
    yAxisFormatter,
    animate = false,
    chartInstance,
    isFirstLoad
}) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`${canvasId} canvas not found!`);
        return;
    }
    const ctx = canvas.getContext('2d');

    // If no chart instance exists or it's the first load, create a new one
    if (!chartInstance || isFirstLoad) {
        if (chartInstance) {
            chartInstance.destroy(); // Destroy the existing instance
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels || [],
                datasets: [{
                    label: datasetLabel,
                    data: values || [],
                    borderColor: 'rgba(146, 176, 174, 0.8)',
                    backgroundColor: 'rgba(146, 176, 174, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: animate ? { duration: 300, easing: 'easeInOutQuad' } : false, // Enable animation only if `animate` is true
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        type: 'time',
                        time: {
                            parser: 'yyyy-MM-dd',
                            unit: 'day',
                            tooltipFormat: 'PP',
                            displayFormats: { day: 'MMM d' }
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10,
                            callback: function (value) {
                                const date = new Date(value);
                                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            },
                            font: { size: tickFontSize, family: 'Play, sans-serif' },
                            padding: 0,
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        title: {
                            display: true,
                            text: yAxisTitle,
                            font: { size: labelFontSize, family: 'Play, sans-serif' }
                        },
                        ticks: {
                            beginAtZero: false,
                            font: { size: tickFontSize, family: 'Play, sans-serif' },
                            callback: yAxisFormatter || function (value) {
                                return parseFloat(value).toFixed(1);
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                layout: {
                    padding: chartPadding
                }
            }
        });
    } else {
        // If the chart instance exists, update its data
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = values;
        chartInstance.update({ duration: 0 }); // No animation on updates
    }

    return chartInstance;
}
    
let publishespiechartInstance = null;
let rewardspiechartInstance = null;
let stakedpiechartinstance = null;

function renderPieChart({
    canvasId, // ID of the canvas element
    legendContainerId, // ID of the custom legend container
    data, // Array of data values
    chartInstance, // Reference to the chart instance (e.g., publishesPieChartInstance)
    isFirstLoad // Flag to track first load
}) {
    const ctx = document.getElementById(canvasId).getContext("2d");
    const total = data.reduce((sum, value) => sum + value, 0);

    // Combine labels, data, and colors into an array of objects for sorting
    const combinedData = ["Neuroweb", "Base", "Gnosis"].map((label, i) => ({
        label: label,
        value: data[i],
        percentage: (data[i] / total * 100).toFixed(1),
        color: ["#262626", "#1f62a1", "#076940"][i]
    }));

    // Sort by percentage in descending order
    combinedData.sort((a, b) => b.percentage - a.percentage);

    // Render custom legend
    const legendContainer = document.getElementById(legendContainerId);
    if (legendContainer) {
        legendContainer.innerHTML = combinedData.map(item => `
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem; font-family: 'Play', sans-serif;">
                <div style="
                    width: ${pieChartFontSize}px; 
                    height: ${pieChartFontSize}px; 
                    background: ${item.color}; 
                    border: ${pieChartBorderWidth}px solid #a6a6a6; 
                    border-radius: 50%; 
                    margin-right: 0.5rem;
                "></div>
                <span style="font-weight: bold;">${item.label} - ${formatValueInMillions(item.value)}</span>
                <span style="margin-left: auto; font-weight: bold;">${item.percentage}%</span>
            </div>
        `).join("");
    }

    // Update or create the chart
    if (isFirstLoad) {
        window[`${canvasId}Instance`] = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: combinedData.map(item => item.label),
                datasets: [{
                    data: combinedData.map(item => item.value),
                    backgroundColor: combinedData.map(item => item.color),
                    borderColor: "#a6a6a6",
                    hoverOffset: 10,
                    borderWidth: pieChartBorderWidth,
                    cutout: "55%"
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Disable default legend
                    }
                }
            }
        });
        isFirstLoad = false;
    } else {
        if (window[`${canvasId}Instance`]) {
            window[`${canvasId}Instance`].data.labels = combinedData.map(item => item.label);
            window[`${canvasId}Instance`].data.datasets[0].data = combinedData.map(item => item.value);
            window[`${canvasId}Instance`].data.datasets[0].backgroundColor = combinedData.map(item => item.color);
            window[`${canvasId}Instance`].update();
        }
    }
}
    
function fetchChartData() {
    const CHART_DATA_BASE_URL = 'https://dkgstats-b5839-default-rtdb.firebaseio.com/data/charts';

    const endpoints = [
        { path: '/price.json', chartId: 'PriceChart', datasetLabel: 'Price', yAxisTitle: 'Price (USD)', yAxisFormatter: null },
        { path: '/spend.json', chartId: 'SpendChart', datasetLabel: 'Spend', yAxisTitle: 'Spend (USD)', yAxisFormatter: (value) => value >= 1000 ? (value / 1000) + 'K' : value },
        { path: '/publishes.json', chartId: 'PublishesChart', datasetLabel: 'Publishes', yAxisTitle: 'Publishes', yAxisFormatter: (value) => value >= 1000000 ? (value / 1000000) + 'M' : value }
    ];

    const fetchPromises = endpoints.map(endpoint => 
        fetch(CHART_DATA_BASE_URL + endpoint.path)
            .then(response => response.json())
            .then(data => {
                console.log(`${endpoint.datasetLabel} Data:`, data);

                if (Array.isArray(data) && data.length > 0) {
                    const labels = data.map(item => item.date);
                    const values = endpoint.path === '/price.json' ? data.map(item => parseFloat(item.value.toFixed(2))) : data.map(item => item.value);

                    // Check if this is the first data load
                    const isFirstLoad = !window[`${endpoint.chartId}Instance`];

                    // Destroy the existing chart instance if it exists
                    if (window[`${endpoint.chartId}Instance`]) {
                        window[`${endpoint.chartId}Instance`].destroy();
                    }

                    // Create a new chart instance with the fetched data
                    window[`${endpoint.chartId}Instance`] = renderChart({
                        canvasId: endpoint.chartId,
                        labels: labels,
                        values: values,
                        datasetLabel: endpoint.datasetLabel,
                        yAxisTitle: endpoint.yAxisTitle,
                        yAxisFormatter: endpoint.yAxisFormatter,
                        animate: isFirstLoad, // Enable animation only on first load
                        chartInstance: null, // Pass null to create a new instance
                        isFirstLoad: isFirstLoad
                    });
                } else {
                    console.warn(`No valid ${endpoint.datasetLabel.toLowerCase()} data received.`);
                }
            })
            .catch(error => {
                console.error(`Error fetching ${endpoint.datasetLabel.toLowerCase()} data:`, error);
            })
    );

    Promise.all(fetchPromises).then(() => {
        console.log("All chart data fetched and rendered.");
    });
}
    
function fetchPieChartData() {
    const CHART_DATA_BASE_URL = 'https://dkgstats-b5839-default-rtdb.firebaseio.com/data/chains';

    fetch(CHART_DATA_BASE_URL + '.json')
        .then(response => response.json())
        .then(data => {
            console.log("Chains Data:", data);

            if (data) {
                // Extract values for each category
                const publishesValues = [
                    data.neuroweb?.epochPublishes || 0,
                    data.base?.epochPublishes || 0,
                    data.gnosis?.epochPublishes || 0
                ];

                const rewardsValues = [
                    data.neuroweb?.epochRewards || 0,
                    data.base?.epochRewards || 0,
                    data.gnosis?.epochRewards || 0
                ];

                const stakedValues = [
                    data.neuroweb?.stakedAmount || 0,
                    data.base?.stakedAmount || 0,
                    data.gnosis?.stakedAmount || 0
                ];

                // Render the charts with real data
                renderPieChart({
                    canvasId: 'publishesPieChart',
                    legendContainerId: 'customLegendContainer',
                    data: publishesValues,
                    chartInstance: window.publishesPieChartInstance,
                    isFirstLoad: false
                });

                renderPieChart({
                    canvasId: 'rewardsPieChart',
                    legendContainerId: 'customRewardsLegendContainer',
                    data: rewardsValues,
                    chartInstance: window.rewardsPieChartInstance,
                    isFirstLoad: false
                });

                renderPieChart({
                    canvasId: 'stakedPieChart',
                    legendContainerId: 'customStakedLegendContainer',
                    data: stakedValues,
                    chartInstance: window.stakedPieChartInstance,
                    isFirstLoad: false
                });
            } else {
                console.warn("No valid chains data received.");
            }
        })
        .catch(error => {
            console.error("Error fetching chains data:", error);
        });
}

    fetchPieChartData();
    
let dataInterval, chartInterval, piechartInterval;

function startIntervals() {
    if (dataInterval) clearInterval(dataInterval);
    if (chartInterval) clearInterval(chartInterval);
    if (piechartInterval) clearInterval(piechartInterval);

    // Set new intervals
    dataInterval = setInterval(() => fetchData(), 10000);
    chartInterval = setInterval(() => fetchChartData(), 60000);
    piechartInterval = setInterval(() => fetchPieChartData(), 60000);
    
}

startIntervals();

  </script>
  
</body>
</html>
